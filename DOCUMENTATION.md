# Документация проекта "Конфетти" - Интернет-магазин кондитерских изделий

## Технологический стек
- **Фронтенд**: React.js, Tailwind CSS
- **Бэкенд**: Node.js, Express
- **База данных**: SQLite
- **ORM**: Prisma

## Структура проекта
Проект разделен на две основные части:
- `client/` - клиентская часть приложения на React
- `server/` - серверная часть приложения на Express

## Основные возможности
1. Просмотр категорий товаров
2. Просмотр товаров по категориям
3. Детальный просмотр товара
4. Добавление товаров в корзину
5. Оформление заказов
6. Просмотр истории заказов
7. Администрирование (управление товарами, категориями, заказами)

## Процесс разработки и решение проблем

### 1. Настройка проекта

#### Проблема: Управление портами
При разработке возникали проблемы с конфликтами портов, когда несколько инстансов сервера пытались запуститься на одном порту.

**Решение:**
- Создан файл `fixed-port.js`, который гарантирует запуск сервера на фиксированном порту 5001
- В основном `index.js` реализован механизм автоматического поиска свободного порта

### 2. CORS и межсерверное взаимодействие

#### Проблема: Ошибки CORS при отправке запросов
Клиент не мог получить данные с сервера из-за ограничений CORS.

**Решение:**
- Настроен middleware для CORS в Express с разрешением всех источников в режиме разработки:
```javascript
app.use(cors({
  origin: function(origin, callback) {
    console.log('CORS запрос от:', origin);
    callback(null, true);
  },
  credentials: true
}));
```

### 3. Маршрутизация и URL-префиксы

#### Проблема: Дублирование префикса `/api/`
В запросах с клиента формировался путь с двойным префиксом `/api/api/` вместо `/api/`.

**Решение:**
- Добавлен специальный middleware для автоматического исправления путей:
```javascript
// Middleware для исправления двойных путей /api/api/
app.use((req, res, next) => {
  if (req.url.startsWith('/api/api/')) {
    console.log(`Исправление двойного пути: ${req.url} -> ${req.url.replace('/api/api/', '/api/')}`);
    req.url = req.url.replace('/api/api/', '/api/');
  }
  next();
});
```

### 4. Проблемы с HTTP-клиентом

#### Проблема: Неправильная настройка axios
Неправильная конфигурация baseURL в axios приводила к ошибкам при отправке запросов.

**Решение:**
- Обновлена функция `fetchWithRetry` в `client/src/utils/apiUtils.js` для более корректной обработки URL
- Заменены прямые вызовы axios на функцию fetchWithRetry во всех компонентах:
  - ProductsPage
  - AdminCategoriesPage
  - AdminProductsPage
  - HomePage
  - ProductDetailPage

### 5. Несоответствие маршрутов в разных файлах сервера

#### Проблема: Отсутствие маршрутов в index-app.js
В файле `index-app.js`, который используется в `fixed-port.js`, отсутствовали маршруты для категорий и товаров, определенные в основном файле `index.js`.

**Решение:**
- Добавлены маршруты для категорий и товаров из `index.js` в `index-app.js`:
  - GET /api/categories
  - POST /api/categories
  - GET /api/products
  - GET /api/products/:id
  - POST /api/products
  - POST /api/products/:id
  - DELETE /api/products/:id

### 6. Проблемы с созданием заказов

#### Проблема: Ошибка внешнего ключа при создании заказа
При создании заказа возникала ошибка `Foreign key constraint violated: foreign key` из-за несоответствия ID пользователя.

**Решение:**
- Модифицирован маршрут создания заказа для проверки существования пользователя и использования его фактического ID из базы данных:
```javascript
// Проверяем существование пользователя
const user = await prisma.user.findUnique({
  where: { email: req.user.email }
});

if (!user) {
  return res.status(404).json({ message: 'Пользователь не найден' });
}

// Используем ID пользователя из базы данных
const order = await prisma.order.create({
  data: {
    userId: user.id, // Используем ID найденного пользователя вместо req.user.id
    // остальные поля заказа
  }
});
```

### 7. Проблема с редактированием товаров

#### Проблема: Невозможность сохранить изменения товара
При нажатии на кнопку "Сохранить" в форме редактирования товара возникала ошибка "Превышено количество попыток загрузки данных".

**Причина:**
- Клиентская часть отправляла запрос PUT для обновления товара, но на сервере был только маршрут POST
- Функция `fetchWithRetry` в apiUtils.js правильно формировала запрос PUT, но сервер не мог его обработать

**Решение:**
- Добавлен обработчик маршрута PUT для обновления продуктов в index-app.js:
```javascript
app.put('/api/products/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params;
    const { name, description, price, imageUrl, categoryId } = req.body;
    
    if (req.user.role !== 'admin') {
      return res.status(403).json({ message: 'Доступ запрещен' });
    }
    
    const product = await prisma.product.update({
      where: { id: parseInt(id) },
      data: {
        name,
        description,
        price: parseFloat(price),
        imageUrl,
        categoryId: parseInt(categoryId)
      },
      include: { category: true }
    });
    
    res.json(product);
  } catch (error) {
    console.error('Ошибка обновления продукта (PUT):', error);
    res.status(500).json({ message: 'Ошибка сервера' });
  }
});
```

### 8. Аутентификация и авторизация

- Реализована система регистрации и авторизации на основе JWT-токенов
- Добавлена проверка ролей пользователей для доступа к административным функциям
- Созданы защищенные маршруты, требующие аутентификации

## Заключение

В процессе разработки проекта "Конфетти" были успешно решены различные проблемы, связанные с маршрутизацией, CORS, взаимодействием клиента и сервера, а также обработкой данных. 

Итоговый проект представляет собой полнофункциональный веб-магазин кондитерских изделий с возможностями администрирования, управления товарами и обработки заказов.

Разработанная архитектура обеспечивает:
- Разделение клиентской и серверной частей
- Простоту масштабирования
- Надежную обработку ошибок
- Безопасную аутентификацию и авторизацию 